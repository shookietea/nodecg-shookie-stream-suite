<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alert Settings</title>
    <link rel="stylesheet" href="shared-styles.css" />
  </head>
  <body>
    <!-- Enable/Disable -->
    <div class="section">
      <div class="section-content">
        <div class="setting-item">
          <label class="inline">
            <input type="checkbox" id="alerts-enabled" checked />
            <span>Alerts Enabled</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="inline">
            <input type="checkbox" id="alerts-paused" />
            <span>Pause Alert Queue</span>
          </label>
          <div class="info">
            Pauses alert display without clearing queue. Useful during intense
            gameplay moments.
          </div>
        </div>
      </div>
    </div>

    <!-- Alert Types -->
    <div class="section collapsible" data-collapsible id="alerts-types">
      <h3 class="section-header">
        <span class="section-title">Alert Types</span>
        <span class="section-toggle">▼</span>
      </h3>
      <div class="section-content">
        <div class="setting-item">
          <label class="inline">
            <input type="checkbox" id="alerts-show-subs" checked />
            <span>Show Subscriptions</span>
          </label>
          <div class="info">Includes Sub, Resub, and Gift Sub alerts</div>
        </div>
        <div class="setting-item">
          <label class="inline">
            <input type="checkbox" id="alerts-show-cheers" checked />
            <span>Show Cheers/Bits</span>
          </label>
        </div>
        <div class="setting-item">
          <label class="inline">
            <input type="checkbox" id="alerts-show-follows" />
            <span>Show Follows</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Display Settings -->
    <div class="section collapsible" data-collapsible id="alerts-display">
      <h3 class="section-header">
        <span class="section-title">Display Settings</span>
        <span class="section-toggle">▼</span>
      </h3>
      <div class="section-content">
        <div class="setting-item">
          <label for="alerts-duration">Duration (ms):</label>
          <input
            type="number"
            id="alerts-duration"
            min="1000"
            max="30000"
            step="1000"
            value="5000"
          />
          <div class="info">How long each alert displays (1000-30000 ms)</div>
        </div>
        <div class="setting-item">
          <label for="alerts-scale-modifier">
            Alert Scale:
            <span class="slider-value" id="alert-scale-value">1.0x</span>
          </label>
          <input
            type="range"
            id="alerts-scale-modifier"
            min="0.5"
            max="2.0"
            step="0.1"
            value="1.0"
          />
          <div class="info">
            Scales entire alert box including text (0.5x - 2.0x)
          </div>
        </div>
      </div>
    </div>

    <script src="shared.js"></script>
    <script>
      // ============================================================================
      // Element ID Constants
      // ============================================================================

      const ELEMENT_IDS = {
        ENABLED: 'alerts-enabled',
        PAUSED: 'alerts-paused',
        SHOW_SUBS: 'alerts-show-subs',
        SHOW_CHEERS: 'alerts-show-cheers',
        SHOW_FOLLOWS: 'alerts-show-follows',
        DURATION: 'alerts-duration',
        SCALE_MODIFIER: 'alerts-scale-modifier',
        SCALE_VALUE: 'alert-scale-value',
      };

      const settingsRep = nodecg.Replicant('settings');

      // Initialize collapsible sections
      DashboardUtils.initCollapsibleSections();

      // Auto-save helper using DashboardUtils
      const autoSave = DashboardUtils.createAutoSave(settingsRep, 'alerts');
      const immediateSave = DashboardUtils.createImmediateSave(
        settingsRep,
        'alerts'
      );

      // Update alert scale modifier display using DashboardUtils
      DashboardUtils.createSliderUpdater(
        ELEMENT_IDS.SCALE_MODIFIER,
        ELEMENT_IDS.SCALE_VALUE,
        (v) => `${v.toFixed(1)}x`
      );

      /**
       * Gets current alert settings from DOM
       * @returns {Object} Current alert settings
       */
      function getCurrentAlertSettings() {
        return {
          enabled: DashboardUtils.getElementValue(ELEMENT_IDS.ENABLED),
          paused: DashboardUtils.getElementValue(ELEMENT_IDS.PAUSED),
          duration: DashboardUtils.getElementValue(ELEMENT_IDS.DURATION),
          scaleModifier: DashboardUtils.getElementValue(
            ELEMENT_IDS.SCALE_MODIFIER
          ),
          showFollows: DashboardUtils.getElementValue(ELEMENT_IDS.SHOW_FOLLOWS),
          showSubs: DashboardUtils.getElementValue(ELEMENT_IDS.SHOW_SUBS),
          showCheers: DashboardUtils.getElementValue(ELEMENT_IDS.SHOW_CHEERS),
        };
      }

      // Load settings using DashboardUtils
      settingsRep.on('change', (newValue) => {
        if (!newValue) return;
        DashboardUtils.updateElement(
          ELEMENT_IDS.ENABLED,
          newValue.alerts?.enabled !== false
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.PAUSED,
          newValue.alerts?.paused,
          false
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.SHOW_FOLLOWS,
          newValue.alerts?.showFollows,
          false
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.SHOW_SUBS,
          newValue.alerts?.showSubs !== false
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.SHOW_CHEERS,
          newValue.alerts?.showCheers !== false
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.DURATION,
          newValue.alerts?.duration,
          5000
        );
        DashboardUtils.updateElement(
          ELEMENT_IDS.SCALE_MODIFIER,
          newValue.alerts?.scaleModifier,
          1.0
        );
        // Manually update slider display
        const alertScale = newValue.alerts?.scaleModifier || 1.0;
        document.getElementById(ELEMENT_IDS.SCALE_VALUE).textContent =
          alertScale.toFixed(1) + 'x';
      });

      // Auto-save on input (debounced for slider and number)
      DashboardUtils.addListeners(
        [ELEMENT_IDS.DURATION, ELEMENT_IDS.SCALE_MODIFIER],
        'input',
        () => autoSave(getCurrentAlertSettings)
      );

      // Immediate save for checkboxes
      DashboardUtils.addListeners(
        [
          ELEMENT_IDS.ENABLED,
          ELEMENT_IDS.PAUSED,
          ELEMENT_IDS.SHOW_FOLLOWS,
          ELEMENT_IDS.SHOW_SUBS,
          ELEMENT_IDS.SHOW_CHEERS,
        ],
        'change',
        () => immediateSave(getCurrentAlertSettings)
      );
    </script>
  </body>
</html>
